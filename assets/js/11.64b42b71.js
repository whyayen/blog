(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{494:function(a,s,e){"use strict";e.r(s);var t=e(4),n=Object(t.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h2",{attrs:{id:"summary"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[a._v("#")]),a._v(" Summary")]),a._v(" "),e("p",[a._v("之前透過 Logstash 的 JDBC input 把資料從 MySQL 匯入到 Elasticsearch，結果發生某個 datetime 欄位的時間竟然差了約 6 個小時，一開始覺得很奇怪，因為存在資料庫的時間都是 "),e("code",[a._v("UTC +00:00")]),a._v("，而 Rails 存進去之前都會統一使用 "),e("code",[a._v("UTC +00:00")]),a._v(" 進行存取，只有在 Application 內會依照預設時區設定顯示，所以一直摸不著頭緒是哪邊造成的，後來發現 MySQL 內的時區是 "),e("code",[a._v("CST")]),a._v("，而 "),e("code",[a._v("CST")]),a._v(" 時區本身有四種含義：")]),a._v(" "),e("ol",[e("li",[a._v("Central Standard Time (標準時間："),e("code",[a._v("UTC -06:00")]),a._v("、夏令時間："),e("code",[a._v("UTC -05:00")]),a._v(")")]),a._v(" "),e("li",[a._v("Australia Central Standard Time ("),e("code",[a._v("UTC +09:30")]),a._v("）")]),a._v(" "),e("li",[a._v("China Standard Time ("),e("code",[a._v("UTC +08:00")]),a._v(")")]),a._v(" "),e("li",[a._v("Cuba Standard Time ("),e("code",[a._v("UTC -04:00")]),a._v(")")])]),a._v(" "),e("p",[a._v("而這原因可能導致原本是台灣時區 "),e("code",[a._v("UTC +08:00")]),a._v("，變成 "),e("code",[a._v("UTC -06:00")]),a._v("，不過我遇到的案例比較特別，是資料庫存的時間已經是 "),e("code",[a._v("UTC +00:00")]),a._v("，但 MySQL 的時區是設 "),e("code",[a._v("CST")]),a._v("，而 JDBC 在抓時當成 Central Standard Time 而造成時間相較資料庫早 6 hrs。")]),a._v(" "),e("h2",{attrs:{id:"解決辦法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解決辦法"}},[a._v("#")]),a._v(" 解決辦法")]),a._v(" "),e("p",[a._v("解決辦法有 2 種，一種是 JDBC Connection String 指定 Timezone，另一種是改 MySQL 時間")]),a._v(" "),e("h3",{attrs:{id:"jdbc-connection-string-加上指定-utc-時區"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jdbc-connection-string-加上指定-utc-時區"}},[a._v("#")]),a._v(" JDBC Connection String 加上指定 UTC 時區")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('jdbc {\n  ...\n  jdbc_connection_string => "jdbc:mysql://${DB_HOST}/${DB_DATABASE}?useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=UTC"\n  ...\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br")])]),e("h3",{attrs:{id:"修改-mysql-default-timezone"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改-mysql-default-timezone"}},[a._v("#")]),a._v(" 修改 MySQL default timezone")]),a._v(" "),e("ol",[e("li",[a._v("編輯 MySQL 檔案")])]),a._v(" "),e("p",[e("strong",[a._v("Linux")])]),a._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("vi")]),a._v(" /etc/mysql/mysql.conf.d/mysqld.cnf\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[e("strong",[a._v("MacOS")])]),a._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /usr/local/etc/my.cnf\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[a._v("設定 default timezone")])]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('[mysqld]\n...\ndefault-time-zone = "+00:00"\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[a._v("Restart MySQL")])]),a._v(" "),e("h2",{attrs:{id:"結論"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#結論"}},[a._v("#")]),a._v(" \b結論")]),a._v(" "),e("p",[a._v("因為時區基本上會透過 Rails 轉成 UTC 存在 DB，所以我們最終選擇使用方法二，直接修改 MySQL default timezone，因為沒使用什麼時間函數，所以沒什麼影響，如果要直接改 DB 時間，可能需確認是否會影響 Application 本身。然後 sync 到 Elasticsearch 的資料，舊的有時間差的資料，我們就沒進行處理了，畢竟四個小時後就沒影響。")])])}),[],!1,null,null,null);s.default=n.exports}}]);